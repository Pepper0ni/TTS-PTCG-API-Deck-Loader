CodeToSetID={
 ["JTR"]="sv9",
 ["SV9"]="sv9",
 ["PRE"]="sv8pt5",
 ["SV8PT5"]="sv8pt5",
 ["SSP"]="sv8",
 ["SV8"]="sv8",
 ["SCR"]="sv7",
 ["SV7"]="sv7",
 ["SFA"]="sv6pt5",
 ["SV6PT5"]="sv6pt5",
 ["TWM"]="sv6",
 ["SV6"]="sv6",
 ["TEF"]="sv5",
 ["SV5"]="sv5",
 ["PAF"]="sv4pt5",
 ["SV4PT5"]="sv4pt5",
 ["PAR"]="sv4",
 ["SV4"]="sv4",
 ["MEW"]="sv3pt5",
 ["SV3PT5"]="sv3pt5",
 ["OBF"]="sv3",
 ["SV3"]="sv3",
 ["PAL"]="sv2",
 ["SV2"]="sv2",
 ["SVI"]="sv1",
 ["SV1"]="sv1",
 ["SVE"]="sve",
 ["SVP"]="svp",
 ["PR-SV"]="svp",
 ["CRZGG"]="swsh12pt5gg",
 ["CRZ-GG"]="swsh12pt5gg",
 ["CRZ"]="swsh12pt5",
 ["SITTG"]="swsh12tg",
 ["SIT-TG"]="swsh12tg",
 ["SIT"]="swsh12",
 ["LORTG"]="swsh11tg",
 ["LOR-TG"]="swsh11tg",
 ["LOR"]="swsh11",
 ["MCD22"]="mcd22",
 ["PGO"]="pgo",
 ["ASRTG"]="swsh10tg",
 ["ASR-TG"]="swsh10tg",
 ["ASR"]="swsh10",
 ["BRSTG"]="swsh9tg",
 ["BRS-TG"]="swsh9tg",
 ["BRS"]="swsh9",
 ["FST"]="swsh8",
 ["CELC"]="cel25c",
 ["CEL"]="cel25",
 ["MCD21"]="mcd21",
 ["EVS"]="swsh7",
 ["CRE"]="swsh6",
 ["BST"]="swsh5",
 ["SHFSV"]="swsh45sv",
 ["SHF"]="swsh45",
 ["VIV"]="swsh4",
 ["CPA"]="swsh35",
 ["FUT20"]="fut20",
 ["DAA"]="swsh3",
 ["RCL"]="swsh2",
 ["SSH"]="swsh1",
 ["PR-SW"]="swshp",
 ["CEC"]="sm12",
 ["MCD19"]="mcd19",
 ["HIFSV"]="sma",
 ["sma"]="sma",
 ["SMA"]="sma",
 ["HIF"]="sm115",
 ["UNM"]="sm11",
 ["UNB"]="sm10",
 ["DET"]="det1",
 ["TEU"]="sm9",
 ["LOT"]="sm8",
 ["MCD18"]="mcd18",
 ["DRM"]="sm75",
 ["CES"]="sm7",
 ["FLI"]="sm6",
 ["UPR"]="sm5",
 ["MCD17"]="mcd17",
 ["CIN"]="sm4",
 ["SLG"]="sm35",
 ["BUS"]="sm3",
 ["GRI"]="sm2",
 ["SUM"]="sm1",
 ["PR-SM"]="smp",
 ["EVO"]="xy12",
 ["MCD16"]="mcd16",
 ["STS"]="xy11",
 ["FCO"]="xy10",
 ["FAC"]="xy10",
 ["GEN"]="g1",
 ["BKP"]="xy9",
 ["MCD15"]="mcd15",
 ["BKT"]="xy8",
 ["AOR"]="xy7",
 ["ROS"]="xy6",
 ["DCR"]="dc1",
 ["PRC"]="xy5",
 ["PHF"]="xy4",
 ["FFI"]="xy3",
 ["MCD14"]="mcd14",
 ["FLF"]="xy2",
 ["XY"]="xy1",
 ["KSS"]="xy0",
 ["PR-XY"]="xyp",
 ["LTR"]="bw11",
 ["PLB"]="bw10",
 ["PLF"]="bw9",
 ["PLS"]="bw8",
 ["BCR"]="bw7",
 ["DRV"]="dv1",
 ["DRX"]="bw6",
 ["MCD12"]="mcd12",
 ["DEX"]="bw5",
 ["NXD"]="bw4",
 ["NVI"]="bw3",
 ["EPO"]="bw2",
 ["MCD11"]="mcd11",
 ["BLW"]="bw1",
 ["PR-BLW"]="bwp",
 ["CL"]="col1",
 ["TM"]="hgss4",
 ["UD"]="hgss3",
 ["UL"]="hgss2",
 ["PR-HS"]="hsp",
 ["HS"]="hgss1",
 ["RM"]="ru1",
 ["RU1"]="ru1",
 ["AR"]="pl4",
 ["SV"]="pl3",
 ["RR"]="pl2",
 ["P9"]="pop9",
 ["POP9"]="pop9",
 ["pop9"]="pop9",
 ["PL"]="pl1",
 ["SF"]="dp7",
 ["P8"]="pop8",
 ["POP8"]="pop8",
 ["pop8"]="pop8",
 ["LA"]="dp6",
 ["MD"]="dp5",
 ["P7"]="pop7",
 ["POP7"]="pop7",
 ["pop7"]="pop7",
 ["GE"]="dp4",
 ["SW"]="dp3",
 ["P6"]="pop6",
 ["POP6"]="pop6",
 ["pop6"]="pop6",
 ["MT"]="dp2",
 ["DP"]="dp1",
 ["PR-DPP"]="dpp",
 ["PK"]="ex16",
 ["P5"]="pop5",
 ["POP5"]="pop5",
 ["pop5"]="pop5",
 ["DF"]="ex15",
 ["P4"]="pop4",
 ["POP4"]="pop4",
 ["pop4"]="pop4",
 ["CG"]="ex14",
 ["HP"]="ex13",
 ["P3"]="pop3",
 ["POP3"]="pop3",
 ["pop3"]="pop3",
 ["TK2M"]="tk2b",
 ["TK2P"]="tk2a",
 ["TK2B"]="tk2b",
 ["TK2A"]="tk2a",
 ["LM"]="ex12",
 ["DS"]="ex11",
 ["P2"]="pop2",
 ["POP2"]="pop2",
 ["pop2"]="pop2",
 ["UF"]="ex10",
 ["EM"]="ex9",
 ["DX"]="ex8",
 ["TRR"]="ex7",
 ["P1"]="pop1",
 ["POP1"]="pop1",
 ["pop1"]="pop1",
 ["RG"]="ex6",
 ["HL"]="ex5",
 ["TK1O"]="tk1b",
 ["TK1A"]="tk1a",
 ["TK1B"]="tk1b",
 ["MA"]="ex4",
 ["PR-NP"]="np",
 ["DR"]="ex3",
 ["SS"]="ex2",
 ["RS"]="ex1",
 ["SK"]="ecard3",
 ["SKR"]="ecard3",
 ["AQ"]="ecard2",
 ["AQP"]="ecard2",
 ["BP"]="bp",
 ["EX"]="ecard1",
 ["EXP"]="ecard1",
 ["LC"]="base6",
 ["N4"]="neo4",
 ["N3"]="neo3",
 ["SI"]="si1",
 ["SI1"]="si1",
 ["N2"]="neo2",
 ["N1"]="neo1",
 ["G2"]="gym2",
 ["G1"]="gym1",
 ["TR"]="base5",
 ["B2"]="base4",
 ["FO"]="base3",
 ["JU"]="base2",
 ["BS"]="base1",
 ["PR"]="basep",
}

prefixs={
 ["swsh12pt5gg"]="GG",
 ["swsh12tg"]="TG",
 ["swsh11tg"]="TG",
 ["swsh10tg"]="TG",
 ["swsh9tg"]="TG",
 ["swshp"]="SWSH",
 ["smp"]="SM",
 ["xyp"]="XY",
 ["bwp"]="BW",
 ["hsp"]="HGSS",
}

energyTable={
 {set="Base",
  display="Base Set",
  api=true,
  code="base1",
  rarity="C",
  types={
   Grass={num="99"},
   Fire={num="98"},
   Water={num="102"},
   Lightning={num="100"},
   Psychic={num="101"},
   Fighting={num="97"},
  },
  date="19990109"
 },
 {set="Expedition Base Set",
  display="E-Card",
  api=true,
  code="ecard1",
  rarity="C",
  types={
   Grass={num="162"},
   Fire={num="161"},
   Water={num="165"},
   Lightning={num="163"},
   Psychic={num="164"},
   Fighting={num="160"},
  },
  date="20020915"
 },
 {set="Ruby & Sapphire",
  display="EX era",
  api=true,
  code="ex1",
  rarity="C",
  types={
   Grass={num="104"},
   Fire={num="108"},
   Water={num="106"},
   Lightning={num="109"},
   Psychic={num="107"},
   Fighting={num="105"},
  },
  date="20030701"
 },
 {set="EX energies",
  display="EX holo",
  types={
   Grass={steamUrl="2343629677880319136/CADDBDA7830051F99D5D5F92FC95FA61A25F93E5",num="g"},
   Fire={steamUrl="2343629677880321272/7986641E761E1F2EFC2CA97F277C3679E2A91FE1",num="r"},
   Water={steamUrl="2343629677880322866/B4DB42E68CCC32462EF05F671B87573DA191BD1F",num="w"},
   Lightning={steamUrl="2343629677880322061/53444B9A79733C5990B1791284FBBA024DAF39DB",num="l"},
   Psychic={steamUrl="2343629677880320405/489F5C0F0599A6E414F16644D0E834176E679F3F",num="p"},
   Fighting={steamUrl="2343629677880317646/B13F72EF9D58D9101FEBEE41CC48FA7C4F12FC25",num="f"}
  },
  date="20030701"
 },
 {set="Emerald",--5
  api=true,
  code="ex9",
  rarity="RH",
  types={
   Grass={num="101"},
   Fire={num="102"},
   Water={num="103"},
   Lightning={num="104"},
   Psychic={num="105"},
   Fighting={num="106"}
  },
  date="20050501"
 },
 {set="Holon Phantoms",
  display="HP",
  api=true,
  code="ex13",
  rarity="RH",
  types={
   Grass={num="105"},
   Fire={num="106"},
   Water={num="107"},
   Lightning={num="108"},
   Psychic={num="109"},
   Fighting={num="110"}
  },
  date="20060501"
 },
 {set="Power Keepers",
  display="PK",
  api=true,
  code="ex16",
  rarity="RH",
  types={
   Grass={num="103"},
   Fire={num="104"},
   Water={num="105"},
   Lightning={num="106"},
   Psychic={num="107"},
   Fighting={num="108"}
  },
  date="20070202"
 },
 {set="Diamond & Pearl Energies",
  display="DPP",
  types={
   Grass={steamUrl="2343629677863832988/CF6EA8E45765E56FA878C83DF984CFC07AFA497F",num="g"},
   Fire={steamUrl="2343629677863837434/3516B0FA01F916B212633F1787E1891A954F4EE2",num="r"},
   Water={steamUrl="2343629677863834882/FD799DE45B23E0D4AA55A5DA3758BFD4512BF928",num="w"},
   Lightning={steamUrl="2343629677863834341/DF224402C3415074747FD8B071DE8FB4DD7FAFD3",num="l"},
   Psychic={steamUrl="2343629677863833671/1BA63785A474429BB304C61255E4B22AFDFE9228",num="p"},
   Fighting={steamUrl="2343629677863832508/AA01D7E8B52A60FF3EF5BC9C0E9B1781FCB3E536",num="f"},
   Darkness={steamUrl="2343629677863835835/305F9A1F1838228443D79261AB9FA7BB3205F3AA",num="d"},
   Metal={steamUrl="2343629677863836773/BC1F533351EB02592819AB466D12532A53CE5298",num="m"}
  },
  date="20070501"
 },
 {set="Movie Commemoration Random Pack",
  display="JP Only Movie",
  types={
   Grass={steamUrl="1832405798625465500/D3730F4B293AB62AB619693A2CB66F775773DC7C",num="g"},
   Fire={steamUrl="1832405798625455940/509F5D4C4FC7777ACD7C262255FD40E8AAD5462D",num="r"},
   Water={steamUrl="1832405798625485038/0A15524996F5202AE08493ED09AE0AC47B6A5CD8",num="w"},
   Lightning={steamUrl="1832405798625494298/F8DFA471580360CB70787FA0889BD65D7240FD69",num="l"},
   Psychic={steamUrl="1832405798625513601/B00633C1C3D9963186F18792FD692591D2743132",num="p"},
   Fighting={steamUrl="1832405798625522357/12D4FAB3EDA2E47C3A56A5F2A5D90FA54173E2DD",num="f"},
   Darkness={steamUrl="1832405798625455574/3CAEED33508C134DFBF7DE1EBEAC9E00B534A639",num="d"},
   Metal={steamUrl="1832405798625531534/F2EEA63644E26D0EDA05D8BA1ECF15952ADBF36D",num="m"}
  },
  date="20090718"
 },
 {set="HeartGold & SoulSilver Energies",--10
  display="HGSS Border",
  types={
   Grass={steamUrl="2343629677876910470/47D6E5303F54C2C3893C1A4D1CBAB57EF95E6421",num="g"},
   Fire={steamUrl="2343629677876911495/297B5D6617946FD7B79F82E5F282C141F6C1F667",num="r"},
   Water={steamUrl="2343629677876913078/EB9405786CEE39034730BA1FDAD4C8E5113DA3F1",num="w"},
   Lightning={steamUrl="2343629677876914607/1E690F3EB695CC2B997478E97F10674AB08E03E7",num="l"},
   Psychic={steamUrl="2343629677876915976/256EEC288C26A6C90325CBAEE3DD0F44D6603967",num="p"},
   Fighting={steamUrl="2343629677876916960/28FAFC71C3958413A26A34018991DD9D460FE425",num="f"},
   Darkness={steamUrl="2343629677876918212/925E160271FB44AF0280E0BECC37EF19F14CFB35",num="d"},
   Metal={steamUrl="2343629677876919189/C851C41BBC04D7EA86DC2E0AF00819F49FDF7AAB",num="m"}
  },
  date="20100210"
 },
 {set="HeartGold & SoulSilver",
  display="HGSS art",
  api=true,
  code="hgss1",
  rarity="C",
  types={
   Grass={num="115"},
   Fire={num="116"},
   Water={num="117"},
   Lightning={num="118"},
   Psychic={num="119"},
   Fighting={num="120"},
   Darkness={num="121"},
   Metal={num="122"}
  },
  date="20100210"
 },
 {set="Black & White",
  api=true,
  code="bw1",
  rarity="C",
  types={
   Grass={num="105"},
   Fire={num="106"},
   Water={num="107"},
   Lightning={num="108"},
   Psychic={num="109"},
   Fighting={num="110"},
   Darkness={num="111"},
   Metal={num="112"}
  },
  date="20110425"
 },
 {set="XY",
  api=true,
  code="xy1",
  rarity="C",
  types={
   Grass={num="132"},
   Fire={num="133"},
   Water={num="134"},
   Lightning={num="135"},
   Psychic={num="136"},
   Fighting={num="137"},
   Darkness={num="138"},
   Metal={num="139"},
   Fairy={num="140"}
  },
  date="20140205"
 },
 {set="Generations",
  api=true,
  code="g1",
  rarity="C",
  types={
   Grass={num="75"},
   Fire={num="76"},
   Water={num="77"},
   Lightning={num="78"},
   Psychic={num="79"},
   Fighting={num="80"},
   Darkness={num="81"},
   Metal={num="82"},
   Fairy={num="83"}
  },
  date="20160222"
 },
 {set="Premium Champion Pack",--15
  display="JP only BREAK",
  types={
   Grass={steamUrl="1826780185929566902/E45311C6220C493CA3C4EB2AF5C0159DAC30505A",num="g"},
   Fire={steamUrl="1826780185929565257/0A45F2A992524F7CF3B06F5844B91D369C886BB5",num="r"},
   Water={steamUrl="1826780185929557394/B53B3B212AC022D2F63321B506B48C01BC48356D",num="w"},
   Lightning={steamUrl="1826780185929658153/64A245A57616D852ABD5F8642E51E26360FEA6F9",num="l"},
   Psychic={steamUrl="1826780185929566466/EEE00F8A2965ABA69787FE4EF45F3E3C7226DF0E",num="p"},
   Fighting={steamUrl="1826780185929565784/13E554629E5EF15FB7CA2FADD41238B6F5F8D8A7",num="f"},
   Darkness={steamUrl="1826780185929566147/8D2FC67A2409D375AEC24FA7F80EB1E935885FA5",num="d"},
   Metal={steamUrl="1826780185929556601/A7ECCDAF131757924EE05C9DB8454713CC7E5708",num="m"},
   Fairy={steamUrl="1826780185929565521/51D0C1018AE46B2C3A95BDEA5C2E811FD7A78322",num="y"}
  },
  date="20160416"
 },
 {set="Evolutions",
  api=true,
  code="xy12",
  rarity="C",
  types={
   Grass={num="91"},
   Fire={num="92"},
   Water={num="93"},
   Lightning={num="94"},
   Psychic={num="95"},
   Fighting={num="96"},
   Darkness={num="97"},
   Metal={num="98"},
   Fairy={num="99"}
  },
  date="20161102"
 },
 {set="Sun & Moon Energies",
  display="Sun & Moon",
  rarity="C",
  types={
   Grass={steamUrl="1826780185929832402/5FE64CA2668E4A91ED64DD05E59D74CF958EADEB",num="g"},
   Fire={steamUrl="1826780185929832714/8853045CD1F634E848895927164FB5A522E39CEC",num="r"},
   Water={steamUrl="1826780185929832999/7B1E59BB866F9CBD81888416808101B3519CB8C9",num="w"},
   Lightning={steamUrl="1826780185929833512/90A9B8E6DA4C2F28FB267D97D7213D465DBF3186",num="l"},
   Psychic={steamUrl="1826780185929833839/B5C3FFB69E5180AEF58AABC6B648419A973AD1E5",num="p"},
   Fighting={steamUrl="1826780185929834195/8BB262C2D63EA80E6C04F09136CCD043D75EC2BE",num="f"},
   Darkness={steamUrl="1826780185929834635/F274B54CA2718B0CDADEA30355C2CA435E8A4E1A",num="d"},
   Metal={steamUrl="1826780185929834975/1892F7B06D18C0B1AB7F4FFEC69FF52239D21B5F",num="m"},
   Fairy={steamUrl="1826780185929835278/E2A48B5AD439570D5613491267C9B649055ACA4F",num="y"}
  },
  date="20170203"
 },
 {set="Gen 7 Secret",
  rarity="RS",
  api=true,
  types={
   Grass={code="sm2",setName="Guardians Rising",date="20170505",num="167"},
   Fire={code="sm3",setName="Burning Shadows",date="20170805",num="167"},
   Water={code="sm4",setName="Crimson Invasion",date="20171103",num="124"},
   Lightning={code="sm2",setName="Guardians Rising",date="20170505",num="168"},
   Psychic={code="sm1",setName="Sun & Moon",date="20170203",num="162"},
   Fighting={code="sm2",setName="Guardians Rising",date="20170505",num="169"},
   Darkness={code="sm3",setName="Burning Shadows",date="20170805",num="168"},
   Metal={code="sm1",setName="Sun & Moon",date="20170203",num="163"},
   Fairy={code="sm3",setName="Burning Shadows",date="20170805",num="169"}
  }
 },
 {set="Team Up Energies",
  display="Team Up",
  rarity="C",
  types={
   Grass={steamUrl="1832405798628986164/8DAE81347A07897ACD085586A20D95CF2598E347",num="g"},
   Fire={steamUrl="1832405798628987149/3187D01AA63593BAD2A13058C9A64986771B83D5",num="r"},
   Water={steamUrl="1832405798628988741/04A35BDD099EBE7E18DBB9D7E7AB999D5BA66D9E",num="w"},
   Lightning={steamUrl="1832405798628989261/5967BCC4EB91584ABEB1680F1CF83B70302EAF52",num="l"},
   Psychic={steamUrl="1832405798628989709/D12DB2BE41A2185C11D87062EC08E285969F82A5",num="p"},
   Fighting={steamUrl="1832405798628991233/69EB109A4FE5D47D1B58FB59EC2517A30DB1DA20",num="f"},
   Darkness={steamUrl="1832405798628991928/8B177CCA848C1747B3790053958FAA79F3E0314B",num="d"},
   Metal={steamUrl="1832405798628992609/CC82A01EDC098ABEDA1376083E17D028F387A0A7",num="m"},
   Fairy={steamUrl="1832405798628993182/0CBE5BDF044B22B16510A8699F3B00CAC229C14C",num="y"}
  },
  date="20190201"
 },
 {set="Sword & Shield Energies",--20
  display="SWSH",
  rarity="C",
  types={
   Grass={steamUrl="1832405798628838691/9F72772F0F21C4F6455D35CDDA7C0387D2C344CD",num="g"},
   Fire={steamUrl="1832405798628839998/882EB1317DC1D12FF4994221E57FE41B4ECF8D70",num="r"},
   Water={steamUrl="1832405798628840522/64FB79B3C680D7B11BAEFD367E03115243508AC2",num="w"},
   Lightning={steamUrl="1832405798628842568/67A8211D36AE2FF603C7A4B775C894EA25EA9155",num="l"},
   Psychic={steamUrl="1832405798628843075/407375AECC10AD4150F2C70FBB63A0BAC0A9AE05",num="p"},
   Fighting={steamUrl="1832405798628843991/B1DDC67C84E0E0E1527F85058DCDF038DB9D8663",num="f"},
   Darkness={steamUrl="1832405798628844608/70C62511CA9F2631D1E1DE691F4099A8102EE7EC",num="d"},
   Metal={steamUrl="1832405798628845093/EC66EEED31A9BAB8CCEDBB7152B0B4EC4C9D6F55",num="m"},
   Fairy={steamUrl="1832405798628845735/B64816866B1D0B67963CE2E9114F77A2E9C3BD2E",num="y"}
  },
  date="20200207"
 },
 {set="Gen 8 Secret",
  rarity="RS",
  api=true,
  types={
   Grass={code="swsh8",setName="Fusion Strike",date="20211112",num="283"},
   Fire={code="swsh8",setName="Fusion Strike",date="20211112",num="284"},
   Water={code="swsh6",setName="Chilling Reign",date="20210618",num="231"},
   Lightning={code="swsh7",setName="Evolving Skies",date="20210827",num="235"},
   Psychic={code="swsh6",setName="Chilling Reign",date="20210618",num="232"},
   Fighting={code="swsh6",setName="Chilling Reign",date="20210618",num="233"},
   Darkness={code="swsh7",setName="Evolving Skies",date="20210827",num="236"},
   Metal={code="swsh7",setName="Evolving Skies",date="20210827",num="237"}
  }
 },
 {set="Brilliant Stars Energies",
  display="BS",
  api=true,
  code="swsh12pt5",
  rarity="C",
  types={
   Grass={num="152"},
   Fire={num="153"},
   Water={num="154"},
   Lightning={num="155"},
   Psychic={num="156"},
   Fighting={num="157"},
   Darkness={num="158"},
   Metal={num="159"},
   Fairy={noApi=true,steamUrl="5938629525077704809/AA601036EC69849338EA983AF7061CB66798AC22",num="y",setName="Brilliant Stars Energies"}
  },
  date="20220225"
 },
 {set="Scarlet & Violet",
  display="SV",
  api=true,
  code="sve",
  basic=true,
  types={
   Grass={num="1",setName="Scarlet & Violet Energies"},
   Fire={num="2",setName="Scarlet & Violet Energies"},
   Water={num="3",setName="Scarlet & Violet Energies"},
   Lightning={num="4",setName="Scarlet & Violet Energies"},
   Psychic={num="5",setName="Scarlet & Violet Energies"},
   Fighting={num="6",setName="Scarlet & Violet Energies"},
   Darkness={num="7",setName="Scarlet & Violet Energies"},
   Metal={num="8",setName="Scarlet & Violet Energies"},
   Fairy={noApi=true,steamUrl="5938629525077705258/59388EFF16D70C1BFED9924ADFFAFD252E05F5A5",num="y",setName="Scarlet & Violet Energies"}
  },
  date="20230331"
 },
 {set="Gen 9 Secret",
  rarity="HR",
  basic=true,
  api=true,
  types={
   Grass={code="sv2",setName="Paldea Evolved",date="20230609",num="278"},
   Fire={code="sv3",setName="Obsidian Flames",date="20230811",num="230"},
   Water={code="sv2",setName="Paldea Evolved",date="20230609",num="279"},
   Lightning={code="sv1",setName="Scarlet & Violet",date="20230331",num="257"},
   Psychic={code="sv3pt5",setName="151",date="20230922",num="207"},
   Fighting={code="sv1",setName="Scarlet & Violet",date="20230331",num="258"},
   Darkness={code="sv6pt5",setName="Shrouded Fable",date="20240802",num="98"},
   Metal={code="sv6pt5",setName="Shrouded Fable",date="20240802",num="99"},
  }
 },
 {set="SV Tera",
  display="Tera",
  api=true,
  code="sve",
  basic=true,
  types={
   Grass={num="9",setName="Scarlet & Violet Energies"},
   Fire={num="10",setName="Scarlet & Violet Energies"},
   Water={num="11",setName="Scarlet & Violet Energies"},
   Lightning={num="12",setName="Scarlet & Violet Energies"},
   Psychic={num="13",setName="Scarlet & Violet Energies"},
   Fighting={num="14",setName="Scarlet & Violet Energies"},
   Darkness={num="15",setName="Scarlet & Violet Energies"},
   Metal={num="16",setName="Scarlet & Violet Energies"}
  },
  date="20230331"
 },
}

numtoEnergy={"Grass","Fire","Water","Lightning","Psychic","Fighting","Darkness","Metal","Fairy"}
dumbNumtoEnergy={"Darkness","Fairy","Fighting","Fire","Grass","Lightning","Metal","Psychic","Water"}
letterToEnergy={
 G="Grass",
 R="Fire",
 W="Water",
 L="Lightning",
 P="Psychic",
 F="Fighting",
 D="Darkness",
 M="Metal",
 Y="Fairy"
}
normalSetToEnergy={
 BRS=22,
 TEU=19,
 SSH=20,
 SUM=17
}
energySets={
 SMEnergy={17,19},
 SWSHEnergy={20,22}
}
dumbEnergySets={
 HSEnergy=10,
 BLWEnergy=13,
 XYEnergy=13
}
APIminDigits={
 smp=2,
 swshp=3,
 swsh45sv=3,
 swsh9tg=2,
 swsh10tg=2,
 swsh11tg=2,
 swsh12tg=2,
 swsh12pt5gg=2
}
subSetPrefix={
 HIF={"SV","sma",69},
 SHF={"SV","swsh45sv",73},
 CEL={"CC","cel25c",25},
 BRS={"TG","swsh9tg",186},
 ASR={"TG","swsh10tg",216},
 LOR={"TG","swsh11tg",217},
 SIT={"TG","swsh12tg",215},
 CRZ={"GG","swsh12pt5gg",160},
}
CELNumToID={
CC1="2_A",
CC2="4_A",
CC3="15_A1",
CC4="73_A",
CC5="8_A",
CC6="15_A2",
CC7="15_A3",
CC8="24_A",
CC9="20_A",
CC10="66_A",
CC11="9_A",
CC12="86_A",
CC13="88_A",
CC14="93_A",
CC15="17_A",
CC16="15_A4",
CC17="109_A",
CC18="145_A",
CC19="107_A",
CC20="113_A",
CC21="114_A",
CC22="54_A",
CC23="97_A",
CC24="76_A",
CC25="60_A",
}

lastSearchTime=os.time()
lastSearchText=false
lastSearchCount=false
lastSearchTotal=false
curPos=0
curStart=1
lock=false
quantity={}
energy={}
cardNum=0
spawnData={}
curSet=16

function onLoad(state)
 setUpContextMenu()
 local strValue=""
 if not(not state or state=="")then
  state=json.parse(state)
  strValue=state.value or""
  curSet=state.curSet or 16
 end
 params={
  function_owner=self,
  position={0,0,3.3},
  tooltip="Enter the term to search here.",
  label='Enter Deck List',
  font_size=70,
  width=1500,
  height=3200,
  alignment=3,
  input_function="saveData",
  font_color={0,0,0},
  scale={0.75,1,0.5},
  value=strValue,
 }
 self.createInput(params)
 setUpButtons()
end

function setUpButtons()
 self.clearButtons()
 local params={
  function_owner=self,
  font_size=197,
  width=1500,
  height=220,
  scale={0.75,1,0.5},
  color={1,1,1},
 }
 butWrapper(params,{0,0,1.2},'Get Deck',"Load this decklist as a deck",'loadDecklist')
 params.width=1200
 butWrapper(params,{0,0,1.5},energyTable[curSet].display or energyTable[curSet].set,"The current energy set",'DummyFunc')
 params.width=200
 butWrapper(params,{-1.05,0,1.5},"<","Previous energy Set","prevSet")
 butWrapper(params,{1.05,0,1.5},">","Next energy Set","nextSet")
end

function butWrapper(params,pos,label,tool,func)
 params.position=pos
 params.label=label
 params.tooltip=tool
 params.click_function=func
 self.createButton(params)
end

function loadDecklist(obj,color,alt)
 if os.difftime(os.time(),lastSearchTime)<1 then broadcastToColor("You can't fetch decks that fast.",color,{1,0,0})return end
 if lock then broadcastToColor("Already Searching...",color,{1,0,0})return end
 lock=true
 quantity={}
 energy={}
 cardsNum=0
 local deckText=self.getInputs()[1].value
 for line in string.gmatch(deckText,"[^\r\n]+")do
  local words={}
  local t=1
  for c in string.gmatch(line,"[%d%a!?-]+")do
   words[t]=c
   t=t+1
  end
  local wordsLen=#words
  local wordsNum=tonumber(words[1])
  if wordsNum then
   if words[wordsLen]=="PH"then
    words[wordsLen]=nil
    wordsLen=#words
   end
   local setName=words[wordsLen-1]
   local cardNum=words[wordsLen]
   if CodeToSetID[setName]then
    if normalSetToEnergy[setName]and letterToEnergy[cardNum]then
     addEnergy(normalSetToEnergy[setName],letterToEnergy[cardNum],wordsNum)
    else
     local setID=CodeToSetID[setName]
     if subSetPrefix[setName]then
      if startsWith(cardNum,subSetPrefix[setName][1])then
       setID=subSetPrefix[setName][2]
      elseif tonumber(cardNum)and tonumber(cardNum)>subSetPrefix[setName][3]then
       cardNum=subSetPrefix[setName][1]..tostring(tonumber(cardNum)-subSetPrefix[setName][3])
       setID=subSetPrefix[setName][2]
      end
     end
     if APIminDigits[setID]then
      local prefix=string.match(cardNum,"^%a+")or""
      cardNum=string.gsub(cardNum,"%a","")
      local digits=APIminDigits[setID]
      if #cardNum>digits then
       cardNum=string.gsub(cardNum,"^0+","",1)
      elseif #cardNum<digits then
       while #cardNum<digits do cardNum="0"..cardNum end
      end
      cardNum=prefix..cardNum
     end
     if setID=="cel25c"and CELNumToID[cardNum]then
      cardNum=CELNumToID[cardNum]
     end
     local prefix=""
     if prefixs[setID]and not startsWith(cardNum,prefixs[setID])then
      prefix=prefixs[setID]
     end
     quantity[setID.."-"..prefix..cardNum]=wordsNum+(quantity[setID.."-"..prefix..cardNum]or 0)
     cardsNum=cardsNum+wordsNum
    end
   elseif energySets[setName]then
    cardNum=tonumber(cardNum)
    local energySlot=energySets[setName][1]
    if cardNum>9 then
     cardNum=cardNum-9
     energySlot=energySets[setName][2]
    end
    addEnergy(energySlot,numtoEnergy[tonumber(cardNum)],wordsNum)
    cardsNum=cardsNum+wordsNum
   elseif dumbEnergySets[setName]then
    addEnergy(dumbEnergySets[setName],dumbNumtoEnergy[tonumber(cardNum)],wordsNum)
    cardsNum=cardsNum+wordsNum
   elseif setName=="Energy"then
    if words[wordsLen-2]=="Energy" then
     local numCardNum=tonumber(cardNum)
     if numCardNum<=8 then
      addEnergy(13,numtoEnergy[numCardNum],wordsNum)
     elseif numCardNum<=17 then
      addEnergy(13,numtoEnergy[numCardNum-8],wordsNum)
     elseif numCardNum<=26 then
      addEnergy(17,numtoEnergy[numCardNum-17],wordsNum)
     elseif numCardNum<=35 then
      addEnergy(19,numtoEnergy[numCardNum-26],wordsNum)
     elseif numCardNum<=44 then
      addEnergy(20,numtoEnergy[numCardNum-35],wordsNum)
     else
      addEnergy(22,numtoEnergy[numCardNum-44],wordsNum)
     end
     cardsNum=cardsNum+wordsNum
    else
     addEnergy(curSet,words[wordsLen-2],wordsNum)
     cardsNum=cardsNum+wordsNum
    end
   end
  end
 end
 if cardsNum>0 then
  getDeck(color)
 else
  lock=false
 end
 lastSearchTime=os.time()
end

function addEnergy(trySet,eType,quant)
 local set=setTableCheck(trySet,eType)
 if not energy[eType]then energy[eType]={}end
 energy[eType][set]=quant+(energy[eType][set]or 0)
end

function setTableCheck(trySet,eType)
 if energyTable[trySet].types[eType]then
  return trySet
 end
 return 16
end

function getDeck(color)
 local url="https://api.pokemontcg.io/v2/cards?q="
 local first=true
 for id,quant in pairs(quantity)do
  if first then
   first=false
  else
   url=url.." OR "
  end
  url=url..'id:"'..id..'"'
 end
 if first then
  broadcastToColor("Please enter at least 1 card that is not a basic energy card.",color,{1,0,0})
  lock=false
  return
 end
 --Notes.setNotes(url.."&select=id,name,images,number,rarity,set,supertype,subtypes,types,nationalPokedexNumbers")
 r=WebRequest.get(url.."&select=id,name,images,number,rarity,set,supertype,subtypes,types,nationalPokedexNumbers",function()makeCards(r,color)end)
end

function makeCards(r,color)
 if r.is_error or r.response_code>=400 or r.response_code==0 then
  log(r.error)
  log(r.text)
  log(r.response_code)
  broadcastToColor("Error: "..tostring(r.response_code),color,{1,0,0})
  resetSearch()
 else
  local decoded=json.parse(string.gsub(r.text,"\\u0026","&"))
  local spawnPos=self.positionToWorld({0,5.5,0})
  local spawnRot=self.getRotation()
  local spawnData={}
  local curCard=1
  local spawnLoc={posX=spawnPos[1],posY=spawnPos[2],posZ=spawnPos[3],rotX=spawnRot[1],rotY=spawnRot[2],rotZ=spawnRot[3],scaleX=1,scaleY=1,scaleZ=1}
  if cardsNum==1 then
   local cardData=decoded.data[1]
   spawnData=getCardData(spawnLoc,cardData,getCustomData(cardData.images.large.."?count="..cardData.number),100000,1000)
  else
   spawnData={Name="Deck",
    Transform=spawnLoc,
    DeckIDs={},
    CustomDeck={},
    ContainedObjects={}
   }
   for a=1,decoded.count do
    local cardData=decoded.data[a]
    local DeckID=999+a
    local customData=getCustomData(cardData.images.large.."?count="..cardData.number)
    for b=1,quantity[decoded.data[a].id]do
     spawnData.DeckIDs[curCard]=DeckID*100
     spawnData.CustomDeck[DeckID]=customData
     spawnData.ContainedObjects[curCard]=getCardData(spawnLoc,cardData,customData,DeckID*100,DeckID)
     spawnData.ContainedObjects[curCard]["GUID"]=tostring(123456+curCard)
     curCard=curCard+1
    end
   end
   for eType,eTypeQuants in pairs(energy)do
    for energySetNum,energyQuant in pairs(eTypeQuants)do
     local DeckID=999+curCard
     local customData=getCustomData(getEnergyImageURL(energySetNum,eType))
     for b=1,energyQuant do
      spawnData.DeckIDs[curCard]=DeckID*100
      spawnData.CustomDeck[DeckID]=customData
      spawnData.ContainedObjects[curCard]=getEnergyCardData(energySetNum,eType,spawnLoc,customData,DeckID*100,DeckID)
      spawnData.ContainedObjects[curCard]["GUID"]=tostring(123456+curCard)
      curCard=curCard+1
     end
    end
   end
   spawnData = sortDeck(spawnData)
  end
  spawnObjectData({data=spawnData})
 end
 lock=false
end

function getCardData(spawnLoc,cardData,customData,cardID,deckID)
 local cardType=getSubTypeNum(cardData.subtypes)or subTypeNums[cardData.supertype]or 0
 local monType=enumTable(0,cardData.types,TypeNums,10,200)
 if monType==0 then monType=500 end
 local rar=""
 if cardData.rarity then
  rar=" "..string.gsub(cardData.rarity,"[^%u]","")
 end
 return{Name="CardCustom",
 Transform=spawnLoc,
 Nickname=cardData.name,
 Description=cardData.set.name.." #"..cardData.number..rar,
 GMNotes=tostring(cardType)..convertNatDex(cardData.nationalPokedexNumbers,cardData.subtypes),
 Memo=string.gsub(cardData.set.releaseDate,"/","")..buildCardNumber(cardData.number),
 CardID=cardID,
 CustomDeck={[deckID]=customData},
 LuaScriptState=tostring(monType)
}
end

function getEnergyCardData(trySet,eType,spawnLoc,customData,cardID,deckID)
 local setTable=energyTable[setTableCheck(trySet,eType)]
 local rar=""
 if setTable.rarity then rar=" "..setTable.rarity end
 local name=eType.." Energy"
 if setTable.basic then
  name="Basic "..name
 end
 return{Name="CardCustom",
 Transform=spawnLoc,
 Nickname=name,
 Description=(setTable.types[eType].setName or setTable.set).." #"..setTable.types[eType].num..rar,
 GMNotes="90000000",
 Memo=(setTable.types[eType].date or setTable.date)..buildCardNumber(setTable.types[eType].num),
 CardID=cardID,
 CustomDeck={[deckID]=customData},
 LuaScriptState=500
}
end

function getEnergyImageURL(trySet,eType)
 local setTable=energyTable[setTableCheck(trySet,eType)]
 if setTable.api and not setTable.types[eType].noApi then
  return "https://images.pokemontcg.io/"..(setTable.code or setTable.types[eType].code).."/"..setTable.types[eType].num.."_hires.png?count="..setTable.types[eType].num
 else
  return getSteamUrl(setTable.types[eType].steamUrl)
 end
end

function getCustomData(faceUrl)
 return{FaceURL=faceUrl or"",
  BackURL=getSteamUrl("809997459557414686/9ABD9158841F1167D295FD1295D7A597E03A7487"),
  NumWidth=1,
  NumHeight=1,
  BackIsHidden=true
 }
end

function buildCardNumber(cardNum)
 local numOnly=string.gsub(cardNum,"[^%d]","")
 if numOnly!=cardNum then
  local finalNum=(tonumber(numOnly)or 0)+500
  for c in cardNum:gmatch"[^%d]" do
   if c=="?"then c="}"end
   if c=="!"then c="{"end
   finalNum=string.byte(c)-65+finalNum
  end
  cardNum=tostring(finalNum)
 end
 while #cardNum<3 do cardNum="0"..cardNum end
 return cardNum
end

function enumTable(enum,input,values,multi,extramulti)
 if input then
  for c=1,#input do
   if values[input[c]]then
    enum=enum+values[input[c]]*(1+multi)
    if multi==0 then enum=enum+extramulti else multi=0 end
   end
  end
 end
 return enum
end

function getSubTypeNum(subTypes)
 if subTypes then
  for c=1,#subTypes do
   if subTypeNums[subTypes[c]]then return subTypeNums[subTypes[c]]end
  end
 end
 return false
end

function convertNatDex(dexNums,subTypes)
 if dexNums then dexNum=dexNums[1]else return"0000000"end
 if natDexReplace[dexNum] then
  dexNum=natDexReplace[dexNum]
 else
  dexNum=tostring(dexNum*10)
  while #dexNum<5 do dexNum="0"..dexNum end
 end
 local monSubType=tostring(enumTable(0,subTypes,monSubTypeNums,0,0))
 while #monSubType<2 do monSubType="0"..monSubType end
 return dexNum..monSubType
end

function setUpContextMenu()
 self.addContextMenuItem("Release Lock",function()lock=false end)
end

function sortDeck(data)--credit to dzikakulka
 table.sort(data.ContainedObjects,sortByPoke)
 data.DeckIDs={}
 for c=1,#data.ContainedObjects do
  table.insert(data.DeckIDs,data.ContainedObjects[c].CardID)
 end
 return data
end

function sortByPoke(a,b)
 local aNotes=tonumber(a.GMNotes)
 local bNotes=tonumber(b.GMNotes)
 if #a.GMNotes==6 then aNotes=aNotes*100 end
 if #b.GMNotes==6 then bNotes=bNotes*100 end
 if aNotes and bNotes and aNotes~=bNotes then
  return aNotes<bNotes
 elseif a.Nickname~=b.Nickname then
  return a.Nickname<b.Nickname
 else
  local aMemo=tonumber(a.Memo)
  local bMemo=tonumber(b.Memo)
  if aMemo and bMemo then return aMemo<bMemo end
 end
 return a.CardID<b.CardID
end

function saveData()
 self.script_state=json.serialize({value=self.getInputs()[1].value,curSet=curSet})
end

function prevSet()
 curSet=curSet-1
 if curSet==0 then curSet=#energyTable end
 saveData()
 setUpButtons()
end

function nextSet()
 curSet=curSet+1
 if curSet>#energyTable then curSet=1 end
 saveData()
 setUpButtons()
end

function getSteamUrl(url)
 if url then return"https://steamusercontent-a.akamaihd.net/ugc/"..url.."/"end
end

function startsWith(input,prefix)
 if not prefix then return false end
 return string.sub(input,1,#prefix)==prefix
end

function DummyFunc()
end

subTypeNums={
 ["Trainer"]=3,
 ["Supporter"]=4,
 ["Stadium"]=5,
 ["Pokémon Tool"]=6,
 ["Technical Machine"]=6,
 ["Special"]=8,
 ["Energy"]=9
}

TypeNums={
 Grass=1,
 Fire=2,
 Water=3,
 Lightning=4,
 Psychic=5,
 Fighting=6,
 Darkness=7,
 Metal=8,
 Fairy=9,
 Dragon=10,
 Colorless=11,
}

monSubTypeNums={
 ["Level-Up"]=1,
 BREAK=2,
 EX=3,
 MEGA=1,
 GX=5,
 ["TAG TEAM"]=1,
 SP=7,
 LEGEND=9,
 V=10,
 VMAX=11,
 VSTAR=12,
}

natDexReplace={
 [172]="00245",
 [173]="00345",
 [174]="00385",
 [169]="00425",
 [182]="00455",
 [863]="00535",
 [186]="00625",
 [199]="00805",
 [462]="00823",
 [865]="00827",
 [208]="00955",
 [236]="01055",
 [237]="01075",
 [463]="01085",
 [464]="01123",
 [440]="01127",
 [242]="01135",
 [465]="01145",
 [230]="01175",
 [439]="01215",
 [866]="01225",
 [212]="01233",
 [238]="01237",
 [239]="01245",
 [466]="01253",
 [240]="01257",
 [467]="01265",
 [196]="01361",
 [197]="01362",
 [470]="01363",
 [471]="01364",
 [700]="01365",
 [233]="01373",
 [474]="01377",
 [446]="01425",
 [468]="01765",
 [298]="01825",
 [438]="01845",
 [424]="01905",
 [469]="01935",
 [430]="01985",
 [429]="02005",
 [360]="02015",
 [472]="02075",
 [461]="02155",
 [473]="02215",
 [864]="02225",
 [458]="02255",
 [862]="02645",
 [475]="02825",
 [476]="02995",
 [406]="03145",
 [407]="03155",
 [477]="03565",
 [433]="03575",
 [478]="03625",
 [867]="05635",
 [899]="02345",
 [900]="01237",
 [901]="02175",
 [902]="05505",
 [903]="02157",
 [904]="02115",
 [979]="00575",
 [980]="01945",
 [981]="02035",
 [982]="02065",
 [983]="06255",
 [1011]="08425",
 [1018]="08845",
 [1019]="08426",
}
